<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>관리자 - 재고 출고 (증정/시상)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root{
      --primary:#4361ee;
      --primary-dark:#3a56d4;
      --secondary:#7209b7;
      --danger:#f72585;
      --gray:#6c757d;
      --border:#dee2e6;
      --card-shadow:0 4px 12px rgba(0,0,0,.08);
      --transition:.25s ease;
    }
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;}
    body{background:#f5f7fb;color:#212529;line-height:1.6;}

    .container{
      width:95%;
      max-width:1000px;
      margin:0 auto;
      padding:0 16px;
    }
    body > .container{padding-top:25px;}

    .page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;}
    .page-title{font-size:1.5rem;font-weight:700;display:flex;align-items:center;gap:10px;}
    .page-title i{color:var(--primary);}

    .btn{
      padding:10px 16px;border:none;border-radius:8px;font-weight:600;
      font-size:.95rem;cursor:pointer;transition:var(--transition);
      display:flex;align-items:center;justify-content:center;gap:8px;
    }
    .btn-outline{background:#fff;color:#212529;border:1px solid var(--border);}
    .btn-outline:hover{background:#f8f9fa;}
    .btn-danger{background:var(--danger);color:#fff;}
    .btn-danger:hover{background:#e11573;}
    .btn-primary{background:var(--primary);color:#fff;}
    .btn-primary:hover{background:var(--primary-dark);}

    .form-container{
      background:#fff;border-radius:12px;padding:24px;
      box-shadow:var(--card-shadow);margin-bottom:30px;
    }
    .form-group{margin-bottom:18px;}
    .form-group label{display:block;margin-bottom:8px;font-weight:600;}
    .form-control{width:100%;padding:12px;border:1px solid var(--border);border-radius:8px;font-size:1rem;}
    .form-row{display:flex;gap:16px;}
    .form-row .form-group{flex:1;}
    
    /* ⬇️ [신규] 항목 추가 리스트 ⬇️ */
    #item-list-container {
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px;
      min-height: 50px;
      background: #fdfdfd;
      margin-bottom: 20px;
    }
    .giveaway-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid #f0f0f0;
    }
    .giveaway-item:last-child { border-bottom: none; }
    .giveaway-item span { font-weight: 600; }
    .giveaway-item button {
      background: none; border: none; color: var(--danger);
      font-size: 1.1rem; cursor: pointer; padding: 5px;
    }
    /* ⬆️ [신규] 항목 추가 리스트 ⬆️ */

    .table-card{
      background:#fff;border-radius:12px;box-shadow:var(--card-shadow);
      overflow:hidden;
    }
    .log-table{
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
      background:#fff;
    }
    .log-table thead th,
    .log-table tbody td{
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      text-align:left;
      white-space:normal;
      word-break:keep-all;
      line-height:1.4;
      font-size:.9rem;
    }
    .log-table thead th{
      background:#f8f9fa;
      font-weight:700;
      font-size:.88rem;
      color:#555;
    }
    .log-table tbody tr:last-child td{border-bottom:none;}

    @media (max-width:600px){
      .form-row{flex-direction:column;gap:0;}
      .log-table thead th,
      .log-table tbody td{
        padding:8px 10px;
        font-size:.78rem;
      }
      .log-table thead th{font-size:.76rem;}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="page-header">
      <h1 class="page-title">
        <i class="fas fa-gift"></i> 재고 출고 (증정/시상/파손)
      </h1>
    </div>

    <div class="form-container">
      <h2 style="margin-bottom:20px;">1. 출고 처리</h2>
      
      <div class="form-row">
        <div class="form-group">
          <label for="product_select">상품</label>
          <select id="product_select" class="form-control" onchange="populateSizes(this.value)">
            <option value="">-- 상품을 먼저 선택하세요 --</option>
          </select>
        </div>
        <div class="form-group">
          <label for="size_select">사이즈 (재고)</label>
          <select id="size_select" class="form-control" disabled>
            <option value="">-- 상품을 먼저 선택하세요 --</option>
          </select>
        </div>
      </div>

      <button type="button" class="btn btn-outline" onclick="addItemToCart()" style="width:100%; margin-bottom: 25px;">
        <i class="fas fa-plus"></i> 항목 추가
      </button>

      <form id="stock-out-form" onsubmit="handleStockOut(event)">
        
        <label style="display:block; margin-bottom: 8px; font-weight: 600;">출고할 항목</label>
        <div id="item-list-container">
          <p style="color: var(--gray); text-align: center; padding: 10px 0;">아직 추가된 항목이 없습니다.</p>
        </div>

        <div class="form-row" style="margin-top: 20px;">
          <div class="form-group">
            <label for="recipient_name">수령인</label>
            <input type="text" id="recipient_name" name="recipient_name" class="form-control" required />
          </div>
          <div class="form-group">
            <label for="reason">사유</label>
            <select id="reason" name="reason" class="form-control" required>
              <option value="신규">신규</option>
              <option value="시상">시상</option>
              <option value="파손">파손/폐기</option>
              <option value="재고조정">재고조정</option>
              <option value="기타">기타</option>
            </select>
          </div>
        </div>

        <button type="submit" class="btn btn-primary" style="width:100%;padding:12px;">
          <i class="fas fa-minus-circle"></i> 선택한 항목 일괄 출고
        </button>
      </form>
    </div>

    <div class="page-header" style="margin-top:40px;">
      <h2 class="page-title">2. 최근 출고 내역 (최대 50건)</h2>
      <button class="btn btn-outline" onclick="fetchStockLog()">
        <i class="fas fa-sync-alt"></i> 새로고침
      </button>
    </div>

    <div class="table-card">
      <table class="log-table">
        <thead>
          <tr>
            <th>일시</th>
            <th>상품명</th>
            <th>사이즈</th>
            <th>수령인</th>
            <th>사유</th>
          </tr>
        </thead>
        <tbody id="log-table-body">
          <tr><td colspan="5" style="text-align:center;">로딩 중...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const API_BASE_URL = "https://supermax.kr";
    let stockItems = [];
    let giveawayCart = []; // ⬅️ [신규] 출고용 장바구니

    // 1) 재고 있는 상품 목록 (이전과 동일)
    async function fetchInStockItems(){
      const productSelect = document.getElementById('product_select');
      productSelect.disabled = true;
      try{
        // [수정] API 엔드포인트는 네가 수정한 'is_active'가 제거된 API를 사용
        const res = await fetch(API_BASE_URL + '/college/admin/inventory-in-stock'); 
        if(!res.ok) throw new Error('재고 목록 로딩 실패');
        stockItems = await res.json();

        if(stockItems.length === 0){
          productSelect.innerHTML = '<option value="">출고할 재고가 없습니다.</option>';
          return;
        }

        const products = {};
        stockItems.forEach(it=>{
          (products[it.product_name] ||= []).push(it);
        });

        productSelect.innerHTML = '<option value="">-- 상품을 먼저 선택하세요 --</option>';
        Object.keys(products).sort().forEach(name=>{
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          productSelect.appendChild(opt);
        });
      }catch(err){
        console.error(err);
        alert('재고 목록을 불러오는데 실패했습니다.');
      }finally{
        productSelect.disabled = false;
      }
    }

    // 2) 사이즈 드롭다운 (이전과 동일)
    function populateSizes(productName){
      const sizeSelect = document.getElementById('size_select');
      sizeSelect.innerHTML = '';

      if(!productName){
        sizeSelect.innerHTML = '<option value="">-- 상품을 먼저 선택하세요 --</option>';
        sizeSelect.disabled = true;
        return;
      }

      // [수정] 재고가 0인 항목도 보여주되, 선택 불가능하게
      const sizes = stockItems.filter(it => it.product_name === productName);
      if(sizes.length === 0){
        sizeSelect.innerHTML = '<option value="">재고 없음</option>';
        sizeSelect.disabled = true;
        return;
      }

      sizeSelect.innerHTML = '<option value="">-- 사이즈를 선택하세요 --</option>';
      sizes.forEach(it=>{
        const opt = document.createElement('option');
        opt.value = it.inventory_id;
        opt.textContent = `${it.size} (현재 ${it.stock_quantity}개)`;
        
        // ⬇️ [수정] 재고가 0이거나, 이미 카트에 담겨 재고가 0이 되면 비활성화 ⬇️
        const inCartCount = giveawayCart.filter(cartItem => cartItem.inventory_id === it.inventory_id).length;
        const remainingStock = it.stock_quantity - inCartCount;
        
        if (remainingStock <= 0) {
            opt.disabled = true;
            opt.textContent += ' [재고 없음]';
        }
        
        sizeSelect.appendChild(opt);
      });
      sizeSelect.disabled = false;
    }

    // ⬇️ [신규] 카트(리스트)에 항목 추가
    function addItemToCart() {
        const productSelect = document.getElementById('product_select');
        const sizeSelect = document.getElementById('size_select');
        const inventoryId = parseInt(sizeSelect.value);

        if (!inventoryId) {
            alert('상품과 사이즈를 선택하세요.');
            return;
        }

        const item = stockItems.find(i => i.inventory_id === inventoryId);
        if (!item) {
            alert('상품 정보를 찾을 수 없습니다.');
            return;
        }
        
        // 재고 수량 vs 카트 수량 체크
        const inCartCount = giveawayCart.filter(cartItem => cartItem.inventory_id === inventoryId).length;
        if (inCartCount >= item.stock_quantity) {
            alert('재고가 부족합니다. 이 이상 추가할 수 없습니다.');
            return;
        }

        // 카트에 추가 (간단하게 item 객체 통째로)
        giveawayCart.push(item);
        
        // UI 갱신
        renderGiveawayCart();
        
        // 드롭다운 초기화
        productSelect.value = '';
        sizeSelect.innerHTML = '<option value="">-- 상품을 먼저 선택하세요 --</option>';
        sizeSelect.disabled = true;
    }

    // ⬇️ [신규] 카트(리스트) UI 그리기
    function renderGiveawayCart() {
        const container = document.getElementById('item-list-container');
        if (giveawayCart.length === 0) {
            container.innerHTML = '<p style="color: var(--gray); text-align: center; padding: 10px 0;">아직 추가된 항목이 없습니다.</p>';
            return;
        }

        container.innerHTML = giveawayCart.map((item, index) => {
            return `
                <div class="giveaway-item">
                    <span>${item.product_name} (${item.size})</span>
                    <button type="button" onclick="removeItemFromCart(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
        }).join('');

        // 카트가 변경되었으므로, 사이즈 드롭다운의 재고 상태 갱신
        populateSizes(document.getElementById('product_select').value);
    }
    
    // ⬇️ [신규] 카트(리스트)에서 항목 제거
    function removeItemFromCart(index) {
        giveawayCart.splice(index, 1);
        renderGiveawayCart(); // UI 갱신
    }

    // 3) 최근 출고 로그 (이전과 동일)
    async function fetchStockLog(){
      const tbody = document.getElementById('log-table-body');
      tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">새로고침 중...</td></tr>';
      try{
        const res = await fetch(API_BASE_URL + '/college/admin/stock-log');
        if(!res.ok) throw new Error('출고 내역 로딩 실패');
        const logs = await res.json();

        if(!logs || logs.length === 0){
          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">출고 내역이 없습니다.</td></tr>';
          return;
        }

        tbody.innerHTML = '';
        logs.forEach(log=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${formatTimestamp(log.log_date)}</td>
            <td>${log.product_name}</td>
            <td>${log.size}</td>
            <td>${log.recipient_name}</td>
            <td>${log.reason}</td>
          `;
          tbody.appendChild(tr);
        });
      }catch(err){
        console.error(err);
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#d00;">오류: ${err.message}</td></tr>`;
      }
    }

    // ⬇️ [수정] 4) 출고 처리 (일괄 처리)
    async function handleStockOut(e){
      e.preventDefault();
      
      if (giveawayCart.length === 0) {
          alert('출고할 항목을 1개 이상 추가하세요.');
          return;
      }

      const form = document.getElementById('stock-out-form');
      const fd = new FormData(form);

      const data = {
        // [수정] inventory_id 배열을 전송
        inventory_ids: giveawayCart.map(item => item.inventory_id), 
        reason: fd.get('reason'),
        recipient_name: fd.get('recipient_name'),
      };

      if(!data.reason || !data.recipient_name){
        alert('수령인과 사유를 정확히 입력하세요.');
        return;
      }

      const btn = form.querySelector('button[type="submit"]');
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 처리 중...';

      try{
        // [수정] 새 API 엔드포인트 호출
        const res = await fetch(API_BASE_URL + '/college/admin/stock-out-multiple', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify(data)
        });
        const result = await res.json();
        if(!res.ok) throw new Error(result.message);

        alert(result.message);
        form.reset();
        
        // [수정] 카트와 리스트 비우기
        giveawayCart = [];
        renderGiveawayCart();
        
        const sizeSelect = document.getElementById('size_select');
        sizeSelect.innerHTML = '<option value="">-- 상품을 먼저 선택하세요 --</option>';
        sizeSelect.disabled = true;

        // 목록 갱신
        fetchInStockItems();
        fetchStockLog();
      }catch(err){
        console.error('출고 처리 실패:', err);
        alert(`출고 처리 실패: ${err.message}`);
      }finally{
        btn.disabled = false;
        // [수정] 버튼 텍스트 원복
        btn.innerHTML = '<i class="fas fa-minus-circle"></i> 선택한 항목 일괄 출고';
      }
    }

    // 5) 날짜 포맷 (이전과 동일)
    function formatTimestamp(v){
      if(!v) return '';
      const d = new Date(v);
      const yy = String(d.getFullYear()).slice(-2);
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      const hh = String(d.getHours()).padStart(2,'0');
      const mi = String(d.getMinutes()).padStart(2,'0');
      return `${yy}.${mm}.${dd} ${hh}:${mi}`;
    }

    // 초기 로드 (이전과 동일)
    document.addEventListener('DOMContentLoaded', ()=>{
      fetchInStockItems();
      fetchStockLog();
    });
  </script>
</body>
</html>
