<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>관리자 - 상품/재고 관리</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #7209b7;
            --danger: #f72585;
            --gray: #6c757d;
            --border: #dee2e6;
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fb;
            color: #212529;
            line-height: 1.6;
        }
        
        .container {
            width: 95%;
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 16px;
        }

        /* ⬇️ [수정] 헤더가 없으므로 첫 컨테이너에 상단 여백 추가 ⬇️ */
        body > .container {
            padding-top: 25px;
        }
        
        /* ⬇️ [삭제] 헤더 관련 스타일 전체 삭제 ⬇️ */
        /* header, .header-content, .logo, .admin-nav, .nav-link ... */

        /* 페이지 헤더 */
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; } /* [수정] margin-top 제거 */
        .page-title { font-size: 1.5rem; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .page-title i { color: var(--primary); }
        
        /* 버튼 */
        .btn {
            padding: 10px 16px; border: none; border-radius: 8px; font-weight: 600;
            font-size: 0.95rem; cursor: pointer; transition: var(--transition);
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-outline { background: white; color: #212529; border: 1px solid var(--border); }
        .btn-outline:hover { background: #f8f9fa; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #e11573; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-secondary { background: var(--gray); color: white; }
        .btn-secondary:hover { background: #5a6268; }

        /* 폼 */
        .form-container { background: white; border-radius: 12px; padding: 24px; box-shadow: var(--card-shadow); margin-bottom: 30px; }
        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; }
        .form-control { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; }
        .form-row { display: flex; gap: 16px; }
        .form-row .form-group { flex: 1; }
        
        /* 탭 스타일 */
        .tab-nav {
            display: flex;
            border-bottom: 1px solid var(--border);
            margin: 30px 0 20px;
        }
        .tab-link {
            padding: 12px 20px;
            font-weight: 600;
            color: var(--gray);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
        }
        .tab-link.active {
            color: var(--primary);
            border-bottom: 2px solid var(--primary);
        }

        /* 디렉토리(폴더) 스타일 */
        details {
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 10px;
            background-color: white;
            box-shadow: var(--card-shadow);
            overflow: hidden;
        }
        summary {
            padding: 15px 20px;
            font-weight: bold;
            font-size: 1.0em; 
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        summary:hover {
            background-color: #f9f9f9;
        }
        .product-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap; 
            justify-content: flex-end; 
        }
        .product-sizes-table {
            width: 100%;
            border-collapse: collapse;
        }
        .product-sizes-table th, 
        .product-sizes-table td {
            border-top: 1px solid #eee;
            padding: 12px 20px;
            text-align: center;
        }
        .product-sizes-table th {
            background-color: #f9f9f9;
        }
        input[type="number"].stock-input {
            width: 80px;
            text-align: center;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 6px;
        }
        .controls {
            display: flex;
            gap: 5px;
            justify-content: center;
            align-items: center;
        }

        /* 로딩, 빈 상태 */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        .empty-category-state {
            text-align: center;
            color: var(--gray);
            padding: 20px;
            background: #fafafa;
            border-radius: 8px;
            border: 1px dashed var(--border);
        }

        /* 뱃지, 버튼 */
        .badge {
            display: inline-block;
            padding: .35em .65em;
            font-size: .75em;
            font-weight: 700;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 8px;
            margin-left: 10px;
        }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-warning:hover { background: #e0a800; }

        .badge-success { background-color: #28a745; color: white; }
        .badge-warning { background-color: #ffc107; color: #212529; }

        .product-controls .btn {
            font-size: 0.8rem;
            padding: 5px 10px;
        }

        /* 수정 모달 스타일 */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px 0;
        }
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        .modal-header h2 {
            font-size: 1.3rem;
        }
        .close-btn {
            font-size: 1.5rem;
            color: var(--gray);
            cursor: pointer;
            background: none;
            border: none;
        }
        
        .image-preview-container {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap; 
        }
        .image-preview-item {
            position: relative;
        }
        .image-preview-item img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        .image-preview-item .delete-img-btn {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* 모바일 반응형 */
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            summary {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .product-controls {
                width: 100%;
                justify-content: flex-start;
            }
            .tab-link {
                font-size: 0.9rem; 
                padding: 10px 8px; 
            }
            .controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="page-header">
            <h1 class="page-title">
                <i class="fas fa-boxes"></i> 상품/재고 관리
            </h1>
        </div>
        
        <div class="form-container">
            <h2 style="margin-bottom: 20px;">1. 신규 상품 등록</h2>
            <form id="new-product-form" onsubmit="handleProductSubmit(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label for="product_name">상품명</label>
                        <input type="text" id="product_name" name="product_name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="price">가격 (숫자만)</label>
                        <input type="number" id="price" name="price" class="form-control" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="category">카테고리</label>
                        <select id="category" name="category" class="form-control" required onchange="setDefaultSizes()">
                            <option value="clothing">의류</option>
                            <option value="shoes">신발</option>
                        </select>
                    </div>
                     <div class="form-group">
                        <label for="sizes">적용 사이즈 (쉼표로 구분)</label>
                        <input type="text" id="sizes" name="sizes" class="form-control" placeholder="예: S,M,L,XL 또는 250,255,260" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="images">상품 이미지 (선택, 여러 장 가능)</label>
                    <input type="file" id="images" name="images" class="form-control" accept="image/*" multiple>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 12px;">
                     <i class="fas fa-plus"></i> 신규 상품 등록하기
                </button>
            </form>
        </div>

        <div class="page-header" style="margin-top: 40px;">
             <h2 class="page-title">2. 현재 재고 수정 (입고 처리)</h2>
             <button class="btn btn-outline" onclick="fetchInventory()">
                <i class="fas fa-sync-alt"></i> 새로고침
             </button>
        </div>
        
        <div class="tab-nav">
            <div class="tab-link active" id="tab-ALL" onclick="showCategory('ALL')">
                <i class="fas fa-list"></i> 전체 보기
            </div>
            <div class="tab-link" id="tab-clothing" onclick="showCategory('clothing')">
                <i class="fas fa-tshirt"></i> 의류
            </div>
            <div class="tab-link" id="tab-shoes" onclick="showCategory('shoes')">
                <i class="fas fa-shoe-prints"></i> 신발
            </div>
        </div>

        <div id="inventory-list" style="margin-top: 20px; margin-bottom: 50px;">
            <div class="loading" id="loading" style="display: none; text-align: center; padding: 40px;">
                 <p>재고 목록을 불러오는 중...</p>
            </div>
        </div>
    </div>

    <div id="editModal" class="modal-overlay" onclick="closeEditModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>상품 정보 수정</h2>
                <button class="close-btn" onclick="closeEditModal()">&times;</button>
            </div>
            
            <form id="edit-product-form" onsubmit="handleProductUpdate(event)">
                <input type="hidden" id="edit_product_id" name="edit_product_id">
                
                <div class="form-group">
                    <label for="edit_product_name">상품명</label>
                    <input type="text" id="edit_product_name" name="edit_product_name" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="edit_price">가격</label>
                    <input type="number" id="edit_price" name="edit_price" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="edit_sizes">적용 사이즈 (쉼표로 구분)</label>
                    <input type="text" id="edit_sizes" name="edit_sizes" class="form-control" required>
                </div>

                <div class="form-group">
                    <label>현재 이미지 (클릭 시 삭제)</label>
                    <div id="current-images-preview" class="image-preview-container">
                        </div>
                </div>
                
                <div class="form-group">
                    <label for="new_images">새 이미지 추가 (선택, 여러 장 가능)</label>
                    <input type="file" id="new_images" name="new_images" class="form-control" accept="image/*" multiple>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()" style="flex: 1;">
                        취소
                    </button>
                    <button type="submit" class="btn btn-primary" style="flex: 2;">
                        <i class="fas fa-save"></i> 수정사항 저장
                    </button>
                </div>
            </form>
        </div>
    </div>


    <script>
        const API_BASE_URL = "https://supermax.kr";
        let groupedByProduct = {};
        let currentFilter = 'ALL';

        // 1. 신규 상품 등록
        async function handleProductSubmit(event) {
            event.preventDefault();
            const form = document.getElementById('new-product-form');
            const formData = new FormData(form); 
            
            try {
                const response = await fetch(API_BASE_URL + '/college/admin/products', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                if (!response.ok) throw new Error(result.message);

                alert(result.message);
                form.reset();
                setDefaultSizes();
                fetchInventory(); 

            } catch (error) {
                console.error('상품 등록 실패:', error);
                alert(`상품 등록 실패: ${error.message}`);
            }
        }

        // 2. 데이터 가져오기 (LEFT JOIN 대응)
        async function fetchInventory() {
            const loadingEl = document.getElementById('loading');
            loadingEl.style.display = 'block';

            try {
                const response = await fetch(API_BASE_URL + '/college/admin/inventory');
                if (!response.ok) throw new Error('재고 목록 로딩 실패');
                
                const inventory = await response.json(); 

                const newGrouped = {};
                inventory.forEach(item => {
                    if (!newGrouped[item.product_id]) {
                        newGrouped[item.product_id] = {
                            product_name: item.product_name,
                            price: item.price,
                            category: item.category,
                            is_active: item.is_active,
                            image_urls: item.image_urls, 
                            sizes: [] 
                        };
                    }
                    if (item.inventory_id !== null) {
                        newGrouped[item.product_id].sizes.push({
                            inventory_id: item.inventory_id,
                            size: item.size,
                            stock_quantity: item.stock_quantity
                        });
                    }
                });
                groupedByProduct = newGrouped;

                renderInventory(currentFilter);

            } catch (error) {
                console.error('재고 로딩 실패:', error);
                alert('재고 목록을 불러오는데 실패했습니다.');
                const listContainer = document.getElementById('inventory-list');
                listContainer.innerHTML = '<p style="text-align: center; color: red;">오류: 재고를 불러오지 못했습니다.</p>';
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        // 3. 카테고리 탭 보여주기
        function showCategory(categoryFilter) {
            currentFilter = categoryFilter;
            renderInventory(categoryFilter);
        }

        // 4. 인벤토리 목록 그리기 (render)
        function renderInventory(categoryFilter) {
            const listContainer = document.getElementById('inventory-list');
            
            document.querySelectorAll('.tab-link').forEach(tab => tab.classList.remove('active'));
            document.getElementById(`tab-${categoryFilter}`).classList.add('active');
            
            listContainer.querySelectorAll('details, p').forEach(el => el.remove());

            let hasItems = false; 

            const sortedProductIds = Object.keys(groupedByProduct).sort((a, b) => {
                const nameA = groupedByProduct[a].product_name.toLowerCase();
                const nameB = groupedByProduct[b].product_name.toLowerCase();
                if (nameA < nameB) return -1;
                if (nameA > nameB) return 1;
                return 0;
            });

            for (const productId of sortedProductIds) {
                const product = groupedByProduct[productId]; 

                if (categoryFilter !== 'ALL' && product.category !== categoryFilter) {
                    continue; 
                }
                
                hasItems = true;
                const details = document.createElement('details');
                
                const sizesHtml = product.sizes.map(item => `
                    <tr>
                        <td>${item.size}</td>
                        <td>${item.stock_quantity}</td>
                        <td class="controls">
                            <input type="number" class="stock-input" id="stock-${item.inventory_id}" value="${item.stock_quantity}">
                            <button class="btn btn-primary" style="padding: 6px 10px;" onclick="updateStock(${item.inventory_id}, ${productId})">
                               <i class="fas fa-check"></i> 수정
                            </button>
                        </td>
                    </tr>
                `).join('');

                const isActive = product.is_active;
                
                const statusBadge = isActive
                    ? `<span class="badge badge-success">게시 중</span>`
                    : `<span class="badge badge-warning">숨김</span>`;

                const toggleButton = isActive
                    ? `<button class="btn btn-warning" onclick="event.stopPropagation(); toggleProductStatus(${productId}, ${isActive}, '${product.product_name}')">
                           <i class="fas fa-eye-slash"></i> 숨기기
                       </button>`
                    : `<button class="btn btn-success" onclick="event.stopPropagation(); toggleProductStatus(${productId}, ${isActive}, '${product.product_name}')">
                           <i class="fas fa-eye"></i> 게시
                       </button>`;

                details.innerHTML = `
                    <summary>
                        <span>
                            <i class="fas fa-box-open" style="margin-right: 10px; color: var(--primary);"></i>
                            ${product.product_name}
                            ${statusBadge}
                        </span>
                        <div class="product-controls">
                            <button class="btn btn-outline" style="border-color: var(--primary); color: var(--primary);" 
                                    onclick="event.stopPropagation(); openEditModal(${productId})">
                                <i class="fas fa-edit"></i> 상품 수정
                            </button>
                            ${toggleButton}
                            <button class="btn btn-danger" 
                                    onclick="event.stopPropagation(); deleteProduct(${productId}, '${product.product_name}')">
                                <i class="fas fa-trash"></i> 상품 삭제
                            </button>
                        </div>
                    </summary>
                    <table class="product-sizes-table">
                        <thead>
                            <tr>
                                <th>사이즈</th>
                                <th>현재고</th>
                                <th>재고 수정 (입고)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sizesHtml.length > 0 ? sizesHtml : '<tr><td colspan="3">등록된 사이즈가 없습니다.</td></tr>'}
                        </tbody>
                    </table>
                `;
                listContainer.appendChild(details);
            }

            if (!hasItems && Object.keys(groupedByProduct).length > 0) {
                 listContainer.innerHTML += '<p class="empty-category-state">이 카테고리에는 상품이 없습니다.</p>';
            }
            
            if (Object.keys(groupedByProduct).length === 0) {
                 listContainer.innerHTML += '<p class="empty-category-state">등록된 상품 재고가 없습니다.</p>';
            }
        }

        // 5. 재고 수량 수정
        async function updateStock(inventoryId, productId) {
            const newStock = document.getElementById(`stock-${inventoryId}`).value;
            if (newStock < 0) return alert('재고는 0 이상이어야 합니다.');

            try {
                const response = await fetch(`${API_BASE_URL}/college/admin/inventory/${inventoryId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ newStock: parseInt(newStock) })
                });

                const result = await response.json();
                if (!response.ok) throw new Error(result.message);

                alert(result.message);
                
                const inputField = document.getElementById(`stock-${inventoryId}`);
                inputField.parentElement.previousElementSibling.textContent = newStock;
                
                const sizeItem = groupedByProduct[productId].sizes.find(s => s.inventory_id === inventoryId);
                if (sizeItem) {
                    sizeItem.stock_quantity = parseInt(newStock);
                }

            } catch (error) {
                console.error('재고 수정 실패:', error);
                alert(`재고 수정 실패: ${error.message}`);
            }
        }

        // 6. 상품 삭제
        async function deleteProduct(productId, productName) {
            const confirmation = prompt(`[경고]\n'${productName}' 상품을 정말 삭제하시겠습니까?\n이 상품과 연결된 모든 사이즈, 재고가 영구적으로 삭제됩니다.\n\n삭제하려면 상품명 '${productName}'을(를) 정확히 입력하세요:`);

            if (confirmation !== productName) {
                alert('입력한 상품명이 일치하지 않아 삭제를 취소했습니다.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/college/admin/products/${productId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                if (!response.ok) throw new Error(result.message);

                alert(result.message);
                delete groupedByProduct[productId];
                renderInventory(currentFilter); 

            } catch (error) {
                console.error('상품 삭제 실패:', error);
                alert(`상품 삭제 실패: ${error.message}`);
            }
        }
        
        // 7. 상품 게시/숨김 상태 변경
        async function toggleProductStatus(productId, isActive, productName) {
            const newStatus = !isActive;
            const actionText = newStatus ? '게시' : '숨김';

            if (!confirm(`'${productName}' 상품을(를) '${actionText}' 상태로 변경하시겠습니까?`)) return;

            try {
                const response = await fetch(`${API_BASE_URL}/college/admin/products/${productId}/status`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ isActive: newStatus })
                });
                
                const result = await response.json();
                if (!response.ok) throw new Error(result.message);

                alert(result.message);
                
                if (groupedByProduct[productId]) {
                    groupedByProduct[productId].is_active = newStatus;
                }
                renderInventory(currentFilter);

            } catch (error) {
                console.error('상태 변경 실패:', error);
                alert(`상태 변경 실패: ${error.message}`);
            }
        }

        // 8. 의류 선택 시 기본 사이즈 세팅
        function setDefaultSizes() {
            const category = document.getElementById('category').value;
            const sizesInput = document.getElementById('sizes');
            if (category === 'clothing') {
                sizesInput.value = 'S, M, L, XL, 2XL, 3XL';
            } else if (category === 'shoes') {
                sizesInput.value = '250, 255, 260, 265, 270, 275, 280';
            }
        }
        
        // 9. 수정 모달 열기
        function openEditModal(productId) {
            const product = groupedByProduct[productId];
            if (!product) return;

            const allSizes = product.sizes.map(item => item.size).join(', ');

            document.getElementById('edit_product_id').value = productId;
            document.getElementById('edit_product_name').value = product.product_name;
            document.getElementById('edit_price').value = product.price;
            document.getElementById('edit_sizes').value = allSizes;

            const imgPreview = document.getElementById('current-images-preview');
            imgPreview.innerHTML = ''; 
            
            if (product.image_urls && product.image_urls.length > 0) {
                product.image_urls.forEach(url => {
                    const item = document.createElement('div');
                    item.className = 'image-preview-item';
                    item.setAttribute('data-url', url); 
                    item.innerHTML = `
                        <img src="${API_BASE_URL + url}" alt="상품 이미지">
                        <button type="button" class="delete-img-btn" onclick="removeImage(this)">&times;</button>
                    `;
                    imgPreview.appendChild(item);
                });
            } else {
                imgPreview.innerHTML = `<p>없음</p>`;
            }
            
            document.getElementById('new_images').value = '';

            document.getElementById('editModal').style.display = 'flex';
        }
        
        // 10. 수정 모달에서 이미지 제거
        function removeImage(button) {
            if (confirm('이 이미지를 삭제하시겠습니까? (저장 버튼을 눌러야 최종 반영됩니다)')) {
                button.parentElement.remove(); 
            }
        }

        // 11. 수정 모달 닫기
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        // 12. 수정 폼 전송 처리
        async function handleProductUpdate(event) {
            event.preventDefault();
            const form = document.getElementById('edit-product-form');
            const formData = new FormData(form);
            const productId = document.getElementById('edit_product_id').value;
            
            const keptImages = [];
            document.querySelectorAll('#current-images-preview .image-preview-item').forEach(item => {
                keptImages.push(item.getAttribute('data-url'));
            });
            formData.append('existing_images_to_keep', JSON.stringify(keptImages));

            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 저장 중...';

            try {
                const response = await fetch(`${API_BASE_URL}/college/admin/products/${productId}`, {
                    method: 'PATCH',
                    body: formData
                });
                
                const result = await response.json();
                if (!response.ok) throw new Error(result.message);

                alert(result.message);
                closeEditModal();
                fetchInventory(); 

            } catch (error) {
                console.error('상품 수정 실패:', error);
                alert(`상품 수정 실패: ${error.message}`);
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="fas fa-save"></i> 수정사항 저장';
            }
        }
        
        // 13. [수정] 스크립트 복원 (잘린 부분)
        // 초기 로드
        document.addEventListener('DOMContentLoaded', () => {
            fetchInventory();
            setDefaultSizes();
        });
    </script>
</body>
</html>